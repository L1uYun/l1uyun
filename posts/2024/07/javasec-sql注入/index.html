<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="javasec-sql注入 前置知识 sql注入 没有对用户的输入进行处理(过滤,黑名单,SQL预编译),直接将输入拼接到了sql语句中, 导致执行"><meta name=keywords content=",sec/javasec"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://l1uyun.one/posts/2024/07/javasec-sql%E6%B3%A8%E5%85%A5/><title>javasec-sql注入 | l1uyun☁️ — l1uyun's Blog
</title><link rel=stylesheet href=https://l1uyun.one/main.7ec86b545988b95db913eae589911b139b09ce5bdcae9ce4a659ba5efa58ffe3.css integrity="sha256-fshrVFmIuV25E+rliZEbE5sJzlvcrpzkplm6XvpY/+M="><link rel=apple-touch-icon sizes=180x180 href=https://l1uyun.one/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://l1uyun.one/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://l1uyun.one/favicon-16x16.png><link rel=manifest href=https://l1uyun.one/site.webmanifest><link rel=mask-icon href=https://l1uyun.one/safari-pinned-tab.svg color><link rel="shortcut icon" href=https://l1uyun.one/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="javasec-sql注入"><meta itemprop=description content="javasec-sql注入 前置知识 sql注入 没有对用户的输入进行处理(过滤,黑名单,SQL预编译),直接将输入拼接到了sql语句中, 导致执行"><meta itemprop=datePublished content="2024-07-25T00:00:00+00:00"><meta itemprop=dateModified content="2024-07-25T00:00:00+00:00"><meta itemprop=wordCount content="2658"><meta itemprop=keywords content="Sec/Javasec"><meta name=twitter:card content="summary"><meta name=twitter:title content="javasec-sql注入"><meta name=twitter:description content="javasec-sql注入 前置知识 sql注入 没有对用户的输入进行处理(过滤,黑名单,SQL预编译),直接将输入拼接到了sql语句中, 导致执行"><meta property="og:url" content="https://l1uyun.one/posts/2024/07/javasec-sql%E6%B3%A8%E5%85%A5/"><meta property="og:site_name" content="l1uyun☁️"><meta property="og:title" content="javasec-sql注入"><meta property="og:description" content="javasec-sql注入 前置知识 sql注入 没有对用户的输入进行处理(过滤,黑名单,SQL预编译),直接将输入拼接到了sql语句中, 导致执行"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-25T00:00:00+00:00"><meta property="article:tag" content="Sec/Javasec"><meta property="article:published_time" content="2024-07-25 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-RSXEZVCJT4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-RSXEZVCJT4")</script><link rel=stylesheet href=https://unpkg.com/swiper/swiper-bundle.min.css><script src=https://unpkg.com/swiper/swiper-bundle.min.js></script><link rel=stylesheet href=https://l1uyun.one/css/custom.css></head><body><div class=container><header class=header><span class=header__inner><a href=https://l1uyun.one/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>$ cd /home/l1uyun☁️ </span><span class=logo__cursor style=background-color:#87ceeb></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://l1uyun.one/posts/>Posts</a></li><li><a href=https://l1uyun.one/tags/>Tags</a></li><li><a href=https://l1uyun.one/about/>About</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="22" height="22" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p></p><hr><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://l1uyun.one/tags/sec/javasec/>sec/javasec</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-07-25 00:00</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
2658 Words
<span>&nbsp;&nbsp;</span>
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
6 minutes</p></div><hr><article><h1 class=post-title><a href=https://l1uyun.one/posts/2024/07/javasec-sql%E6%B3%A8%E5%85%A5/>javasec-sql注入</a></h1><div class=post-content><h1 id=javasec-sql注入>javasec-sql注入</h1><h2 id=前置知识>前置知识</h2><h3 id=sql注入>sql注入</h3><p>没有对用户的输入进行处理(过滤,黑名单,SQL预编译),直接将输入拼接到了sql语句中,</p><p>导致执行了用户构造的恶意SQL语句</p><p>SQL注入的语法与使用的数据库相关,与语言无关</p><h3 id=java数据库操作>java数据库操作</h3><h4 id=jdbc>jdbc</h4><p>java database connection</p><p>java提供的数据库驱动库,用于进行数据库连接,执行SQL语句</p><p>JDBC有两个方法执行SQL语句，分别是PrepareStatement和Statement。</p><h4 id=hibernate>Hibernate</h4><p>Hibernate是一个对象关系映射（ORM）框架，它将Java对象与数据库表进行映射，使开发者可以使用面向对象的编程方式来操作数据库。</p><p>Hibernate能够将Java类自动映射到数据库表上，并且能够自动生成SQL语句来操作数据库，减少了手动编写SQL的繁琐工作。</p><h4 id=mybatis>Mybatis</h4><p>Mybatis是一个持久层框架，它通过消除几乎所有的JDBC代码和手动设置参数及获取结果集的工作来简化对数据库的操作。Mybatis可以通过XML或注解的方式将要执行的SQL、参数和结果映射进行配置。</p><p>Mybatis与Hibernate这样的ORM（对象关系映射）框架不同，它更关注SQL本身，适合对数据库操作有较高控制要求的场景。其高效、灵活和简洁的特性，使得它在企业级开发中被广泛使用。</p><h2 id=复现环境>复现环境</h2><p><a href=https://github.com/j3ers3/Hello-Java-Sec>Hello-Java-Sec</a><br><img src=https://img.l1uyun.one/javasec-sql%E6%B3%A8%E5%85%A5_image_1.png><br><a href=https://github.com/bewhale/JavaSec>JavaSec</a><br><img src=https://img.l1uyun.one/javasec-sql%E6%B3%A8%E5%85%A5_image_2.png></p><h2 id=jdbc-1>JDBC</h2><p>JDBC有两个方法执行SQL语句，分别是PrepareStatement和Statement。</p><p>JDBCTemplate是Spring对JDBC的封装</p><h3 id=statement>Statement</h3><p>这就是普通的写法,没有使用预编译</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 采用Statement方法拼接SQL语句，导致注入产生</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>vul1</span>(String<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Class.forName(<span style=color:#a5d6ff>&#34;com.mysql.cj.jdbc.Driver&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Connection<span style=color:#6e7681> </span>conn<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>DriverManager.getConnection(db_url,<span style=color:#6e7681> </span>db_user,<span style=color:#6e7681> </span>db_pass);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Statement<span style=color:#6e7681> </span>stmt<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>conn.createStatement();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#8b949e;font-style:italic>// 拼接语句产生SQL注入</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>sql<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select * from users where id = &#39;&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>id<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;&#39;&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>ResultSet<span style=color:#6e7681> </span>rs<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>stmt.executeQuery(sql);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>...<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p>报错注入的语法</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http://127.0.0.1:8888/SQLI/JDBC/vul1?id<span style=color:#ff7b72;font-weight:700>=</span>1%27%20and%20updatexml<span style=color:#ff7b72;font-weight:700>(</span>1,concat<span style=color:#ff7b72;font-weight:700>(</span>0x7e,<span style=color:#ff7b72;font-weight:700>(</span>SELECT%20user<span style=color:#ff7b72;font-weight:700>())</span>,0x7e<span style=color:#ff7b72;font-weight:700>)</span>,1<span style=color:#ff7b72;font-weight:700>)</span>--%20+
</span></span></code></pre></div><p><img src=https://img.l1uyun.one/javasec-sql%E6%B3%A8%E5%85%A5_image_3.png></p><h3 id=preparestatement>PrepareStatement</h3><p>这里是使用了预编译,但是没有按照预编译的语法来写,还是有漏洞存在</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// PrepareStatement会对SQL语句进行预编译，但如果直接采取拼接的方式构造SQL，此时进行预编译也无用。</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>vul2</span>(String<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Class.forName(<span style=color:#a5d6ff>&#34;com.mysql.cj.jdbc.Driver&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Connection<span style=color:#6e7681> </span>conn<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>DriverManager.getConnection(db_url,<span style=color:#6e7681> </span>db_user,<span style=color:#6e7681> </span>db_pass);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>sql<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select * from users where id = &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>id;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>PreparedStatement<span style=color:#6e7681> </span>st<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>conn.prepareStatement(sql);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>ResultSet<span style=color:#6e7681> </span>rs<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>st.executeQuery();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><p><img src=https://img.l1uyun.one/javasec-sql%E6%B3%A8%E5%85%A5_image_4.png></p><h3 id=jdbctemplate>JDBCTemplate</h3><p>也是一样的,如果使用拼接,而不是使用占位符,就会导致SQL注入</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// JDBCTemplate是Spring对JDBC的封装，如果使用拼接语句便会产生注入</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String,<span style=color:#6e7681> </span>Object<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>vul3</span>(String<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>DriverManagerDataSource<span style=color:#6e7681> </span>dataSource<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>DriverManagerDataSource();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>...<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>JdbcTemplate<span style=color:#6e7681> </span>jdbctemplate<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>JdbcTemplate(dataSource);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>sql_vul<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select * from users where id = &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>id;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#8b949e;font-style:italic>// 安全语句</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#8b949e;font-style:italic>// String sql_safe = &#34;select * from users where id = ?&#34;;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>jdbctemplate.queryForMap(sql_vul);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=黑名单过滤>黑名单过滤</h3><p>修复方法是采用黑名单过滤掉危险字符,当然,最好还是使用预编译的方法</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 采用黑名单过滤危险字符，同时也容易误伤（次方案）</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>static</span><span style=color:#6e7681> </span><span style=color:#ff7b72>boolean</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>checkSql</span>(String<span style=color:#6e7681> </span>content)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#ff7b72;font-weight:700>[]</span><span style=color:#6e7681> </span>black_list<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>{<span style=color:#a5d6ff>&#34;&#39;&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;;&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;--&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;+&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;,&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;%&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;=&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;&gt;&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;*&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;(&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;)&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;and&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;or&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;exec&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;insert&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;delete&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;update&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;count&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;drop&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;chr&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;mid&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;master&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;truncate&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;char&#34;</span>,<span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;declare&#34;</span>};<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>(String<span style=color:#6e7681> </span>s<span style=color:#6e7681> </span>:<span style=color:#6e7681> </span>black_list)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(content.toLowerCase().contains(s))<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#79c0ff>true</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#79c0ff>false</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=使用占位符>使用?占位符</h3><p>解决方法就是采用预编译的正确写法,占位符</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 正确的使用PrepareStatement可以有效避免SQL注入，使用？作为占位符，进行参数化查询</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>safe1</span>(String<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>sql<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select * from users where id = ?&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>PreparedStatement<span style=color:#6e7681> </span>st<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>conn.prepareStatement(sql);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>st.setString(1,<span style=color:#6e7681> </span>id);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>ResultSet<span style=color:#6e7681> </span>rs<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>st.executeQuery();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=使用esapi过滤输入>使用ESAPI过滤输入</h3><p>安全写法是使用ESAPI来对输入进行过滤,当然使用占位符就可以了</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// ESAPI 是一个免费、开源的、网页应用程序安全控件库，它使程序员能够更容易写出更低风险的程序</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>// 官网：https://owasp.org/www-project-enterprise-security-api/</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>String<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>safe3</span>(String<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Codec<span style=color:#ff7b72;font-weight:700>&lt;</span>Character<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>oracleCodec<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>OracleCodec();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>Statement<span style=color:#6e7681> </span>stmt<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>conn.createStatement();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>sql<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select * from users where id = &#39;&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>ESAPI.encoder().encodeForSQL(oracleCodec,<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;&#39;&#34;</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>ResultSet<span style=color:#6e7681> </span>rs<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>stmt.executeQuery(sql);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    
</span></span></span></code></pre></div><h3 id=强制参数类型>强制参数类型</h3><p>不使用string类型的参数,而是写死类型,那样也能避免sql注入</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 如果参数类型为boolean,byte,short,int,long,float,double等，sql语句无法拼接字符串，因此不存在注入</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>Map<span style=color:#ff7b72;font-weight:700>&lt;</span>String,<span style=color:#6e7681> </span>Object<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>safe4</span>(Integer<span style=color:#6e7681> </span>id)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>String<span style=color:#6e7681> </span>sql<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;select * from users where id = &#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>id;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>jdbctemplate.queryForMap(sql);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=总结>总结</h3><p>-jdbc<br>出现SQL注入的条件是</p><p>1、采用Statement方法拼接SQL语句</p><p>2、PrepareStatement会对SQL语句进行预编译，但如果直接采取拼接的方式构造SQL，此时进行预编译也无用。</p><p>3、JDBCTemplate是Spring对JDBC的封装，如果使用拼接语句便会产生注入</p><p>安全写法：SQL语句占位符（?） + PrepareStatement预编译</p><h2 id=mybatis-1>Mybatis</h2><p>MyBatis框架底层已经实现了对SQL注入的防御，但存在使用不当的情况下，仍然存在SQL注入的风险。</p><p>MyBatis支持两种参数符号，一种是#，另一种是$，#使用预编译，$使用拼接SQL。</p><p>这里的问题主要是使用#{}的问题,使用#{}之后,传进来的参数会被转成带双引号的字符串,导致sql语句错误,开发偷懒就使用了${}进行拼接处理.</p><h3 id=order-by-注入>order by 注入</h3><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 由于使用#{}会将对象转成字符串，形成order by &#34;user&#34; desc造成错误，因此很多研发会采用${}来解决，从而造成SQL注入</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@GetMapping</span>(<span style=color:#a5d6ff>&#34;/vul/order&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>List<span style=color:#ff7b72;font-weight:700>&lt;</span>User<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>orderBy</span>(String<span style=color:#6e7681> </span>field,<span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>sort)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>userMapper.orderBy(field,<span style=color:#6e7681> </span>sort);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>// xml方式</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72;font-weight:700>&lt;</span>select<span style=color:#6e7681> </span>id<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;orderBy&#34;</span><span style=color:#6e7681> </span>resultType<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>&#34;com.best.hello.entity.User&#34;</span><span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>select<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span>from<span style=color:#6e7681> </span>users<span style=color:#6e7681> </span>order<span style=color:#6e7681> </span>by<span style=color:#6e7681> </span>${field}<span style=color:#6e7681> </span>${sort}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72;font-weight:700>&lt;/</span>select<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#8b949e;font-style:italic>// 注解方式</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@Select</span>(<span style=color:#a5d6ff>&#34;select * from users order by ${field} desc&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>List<span style=color:#ff7b72;font-weight:700>&lt;</span>User<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>orderBy2</span>(<span style=color:#d2a8ff;font-weight:700>@Param</span>(<span style=color:#a5d6ff>&#34;field&#34;</span>)<span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>field);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                    
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>http://127.0.0.1:8888/SQLI/MyBatis/vul/order?field<span style=color:#ff7b72;font-weight:700>=</span>id&amp;<span style=color:#79c0ff>sort</span><span style=color:#ff7b72;font-weight:700>=</span>desc,1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[{</span><span style=color:#a5d6ff>&#34;id&#34;</span>:2,<span style=color:#a5d6ff>&#34;user&#34;</span>:<span style=color:#a5d6ff>&#34;admin&#34;</span>,<span style=color:#a5d6ff>&#34;pass&#34;</span>:<span style=color:#a5d6ff>&#34;password&#34;</span><span style=color:#ff7b72;font-weight:700>}</span>,<span style=color:#ff7b72;font-weight:700>{</span><span style=color:#a5d6ff>&#34;id&#34;</span>:1,<span style=color:#a5d6ff>&#34;user&#34;</span>:<span style=color:#a5d6ff>&#34;zhangwei&#34;</span>,<span style=color:#a5d6ff>&#34;pass&#34;</span>:<span style=color:#a5d6ff>&#34;123456&#34;</span><span style=color:#ff7b72;font-weight:700>}]</span>
</span></span></code></pre></div><h3 id=搜索框注入>搜索框注入</h3><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>// 模糊搜索时，直接使用<span style=color:#a5d6ff>&#39;%#{q}%&#39;</span> 会报错，部分研发图方便直接改成<span style=color:#a5d6ff>&#39;%${q}%&#39;</span>从而造成注入
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Select<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;select * from users where user like &#39;%</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>q</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>%&#39;&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>List&lt;User&gt; search<span style=color:#ff7b72;font-weight:700>(</span>String q<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// 安全代码,采用concat
</span></span><span style=display:flex><span>@Select<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;select * from users where user like concat(&#39;%&#39;,#{q},&#39;%&#39;)&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>List&lt;User&gt; search<span style=color:#ff7b72;font-weight:700>(</span>String q<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span></code></pre></div><h3 id=in-注入>in 注入</h3><p>这里也是使用了${}来进行了拼接,会导致错误</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    @RequestMapping<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;/in&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    public String in<span style=color:#ff7b72;font-weight:700>(</span>String ids, Model model<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>        try <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>//            List&lt;String&gt; <span style=color:#79c0ff>list</span> <span style=color:#ff7b72;font-weight:700>=</span> Arrays.asList<span style=color:#ff7b72;font-weight:700>(</span>ids.split<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;,&#34;</span><span style=color:#ff7b72;font-weight:700>))</span>;
</span></span><span style=display:flex><span>//            ArrayList&lt;Admin&gt; <span style=color:#79c0ff>adminList</span> <span style=color:#ff7b72;font-weight:700>=</span> injectService.in<span style=color:#ff7b72;font-weight:700>(</span>list<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span><span style=display:flex><span>            ArrayList&lt;Admin&gt; <span style=color:#79c0ff>adminList</span> <span style=color:#ff7b72;font-weight:700>=</span> injectService.in<span style=color:#ff7b72;font-weight:700>(</span>ids<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span><span style=display:flex><span>            model.addAttribute<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;userInfo&#34;</span>, adminList<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span> catch <span style=color:#ff7b72;font-weight:700>(</span>Exception e<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>{</span>
</span></span><span style=display:flex><span>            e.printStackTrace<span style=color:#ff7b72;font-weight:700>()</span>;
</span></span><span style=display:flex><span>            model.addAttribute<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;results&#34;</span>, e.toString<span style=color:#ff7b72;font-weight:700>())</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>&#34;basevul/sqli/mybatis_in&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    //  正确安全写法
</span></span><span style=display:flex><span>    //  @Select<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;&lt;script&gt;&#34;</span> + <span style=color:#a5d6ff>&#34;SELECT * FROM users WHERE id IN &#34;</span> + <span style=color:#a5d6ff>&#34;&lt;foreach item=&#39;item&#39; index=&#39;index&#39; collection=&#39;ids&#39; open=&#39;(&#39; separator=&#39;,&#39; close=&#39;)&#39;&gt;&#34;</span> + <span style=color:#a5d6ff>&#34;#{item}&#34;</span> + <span style=color:#a5d6ff>&#34;&lt;/foreach&gt;&#34;</span> + <span style=color:#a5d6ff>&#34;&lt;/script&gt;&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    //  ArrayList&lt;Admin&gt; in<span style=color:#ff7b72;font-weight:700>(</span>@Param<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;ids&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> List&lt;String&gt; ids<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span><span style=display:flex><span>    @Select<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;Select * from users where id in (</span><span style=color:#a5d6ff>${</span><span style=color:#79c0ff>ids</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)&#34;</span><span style=color:#ff7b72;font-weight:700>)</span>
</span></span><span style=display:flex><span>    ArrayList&lt;Admin&gt; in<span style=color:#ff7b72;font-weight:700>(</span>@Param<span style=color:#ff7b72;font-weight:700>(</span><span style=color:#a5d6ff>&#34;ids&#34;</span><span style=color:#ff7b72;font-weight:700>)</span> String ids<span style=color:#ff7b72;font-weight:700>)</span>;
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=使用排序映射>使用排序映射</h3><p>安全写法是在xml中使用排序映射</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#7ee787>&lt;select</span> id=<span style=color:#a5d6ff>&#34;orderBySafe&#34;</span> resultType=<span style=color:#a5d6ff>&#34;com.best.hello.entity.User&#34;</span><span style=color:#7ee787>&gt;</span>
</span></span><span style=display:flex><span>    select * from users
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;choose&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;when</span> test=<span style=color:#a5d6ff>&#34;field == &#39;id&#39;&#34;</span><span style=color:#7ee787>&gt;</span>
</span></span><span style=display:flex><span>            order by id desc
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;/when&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;when</span> test=<span style=color:#a5d6ff>&#34;field == &#39;user&#39;&#34;</span><span style=color:#7ee787>&gt;</span>
</span></span><span style=display:flex><span>            order by user desc
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;/when&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;otherwise&gt;</span>
</span></span><span style=display:flex><span>            order by id desc
</span></span><span style=display:flex><span>        <span style=color:#7ee787>&lt;/otherwise&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#7ee787>&lt;/choose&gt;</span>
</span></span><span style=display:flex><span><span style=color:#7ee787>&lt;/select&gt;</span>
</span></span></code></pre></div><h3 id=使用>使用#</h3><p>使用Mybatis作为持久层框架，应通过#{}语法进行参数绑定，MyBatis 会创建 PreparedStatement 参数占位符，并通过占位符安全地设置参数。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 使用 #{} 安全编码</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@Select</span>(<span style=color:#a5d6ff>&#34;select * from users where user like CONCAT(&#39;%&#39;, #{user}, &#39;%&#39;)&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>List<span style=color:#ff7b72;font-weight:700>&lt;</span>User<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>queryByUser</span>(<span style=color:#d2a8ff;font-weight:700>@Param</span>(<span style=color:#a5d6ff>&#34;user&#34;</span>)<span style=color:#6e7681> </span>String<span style=color:#6e7681> </span>user);<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=强制参数类型-1>强制参数类型</h3><p>安全写法,强制类型</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 使用 ${} 本身是存在注入的，但由于强制使用Integer或long类型导致注入无效（无法注入字符串）</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#d2a8ff;font-weight:700>@Select</span>(<span style=color:#a5d6ff>&#34;select * from users where id = ${id}&#34;</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span>List<span style=color:#ff7b72;font-weight:700>&lt;</span>User<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>queryById2</span>(<span style=color:#d2a8ff;font-weight:700>@Param</span>(<span style=color:#a5d6ff>&#34;id&#34;</span>)<span style=color:#6e7681> </span>Integer<span style=color:#6e7681> </span>id);<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id=总结-1>总结</h3><p>-MyBatis<br>MyBatis支持两种参数符号，一种是#，另一种是$，#使用预编译，$使用拼接SQL。</p><p>1、order by注入：由于使用#{}会将对象转成字符串，形成order by &ldquo;user&rdquo; desc造成错误，因此很多研发会采用${}来解决，从而造成注入.</p><p>2、like 注入：模糊搜索时，直接使用&rsquo;%#{q}%&rsquo; 会报错，部分研发图方便直接改成&rsquo;%${q}%&lsquo;从而造成注入.</p><p>3、in注入：in之后多个id查询时使用 # 同样会报错，从而造成注入.</p><h1 id=一句话总结>一句话总结</h1><p>在写sql语句时使用预编译,并且正确使用占位符,不要直接进行拼接处理</p><h1 id=引用>引用</h1><p>小迪sec</p></div></article><hr><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://l1uyun.one/posts/2024/07/javasec-xxe/><span class=button__icon>←</span>
<span class=button__text>javasec-xxe</span>
</a></span><span class="button next"><a href=https://l1uyun.one/posts/2024/07/oracle-padding-attack/><span class=button__text>oracle-padding-attack</span>
<span class=button__icon>→</span></a></span></div></div><script src=https://utteranc.es/client.js repo=L1uYun/l1uyun_blog label="blog comment" issue-term=title theme=github-light crossorigin=anonymous async></script></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2024</span>
<span><a href=https://l1uyun.one/></a></span><span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://l1uyun.one/posts/index.xml target=_blank title=rss><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span><span>Made with &#10084; by <a href=https://github.com/rhazdon>Djordje Atlialp</a></span></div></div></footer></div><script type=text/javascript src=https://l1uyun.one/bundle.min.243fec32d3a4ae91a0f3d22849096c696784566f8bf3d340ce4ebfd711d99f3cac4489fe226e2645c6c5c284d863f37ddc0d610af7b3fa108a2d4387981d3db7.js integrity="sha512-JD/sMtOkrpGg89IoSQlsaWeEVm+L89NAzk6/1xHZnzysRIn+Im4mRcbFwoTYY/N93A1hCvez+hCKLUOHmB09tw=="></script><script src=https://l1uyun.one/js/view-image.min.js></script><script>window.ViewImage&&ViewImage.init(".content img")</script></body></html>